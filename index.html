<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Consultas - Veterinaria</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="empresa.jpg" type="image/x-icon">
</head>
<body>
  <!-- Botón menú hamburguesa solo para visitas -->
<button id="menuToggle" class="menu-toggle" title="Mostrar/Ocultar menú" style="display:none;">
  <i class="fas fa-bars"></i>
</button>
  <!-- Botón para ocultar sidebar solo para visitas -->
  <button id="menuToggleBtn" class="menu-toggle" style="display:none;">
    <i class="fas fa-angle-double-left"></i> 
  </button>
  <div class="main-container">
    <!-- Sidebar con navegación -->
    <aside class="sidebar">
      <div class="logo">
        <img src="empresa.jpg" alt="Logo Veterinaria">
        <h1>Veterinaria San Martin de Porres</h1>
      </div>
      
      <!-- Añadir información del usuario -->
      <div class="user-info">
        <div class="user-avatar">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="user-details">
          <p id="userName">Usuario</p>
          <span id="userRole">Rol</span>
        </div>
      </div>
      
      <nav>
        <button id="crearTicketBtn"><i class="fas fa-plus-circle"></i> Crear Consulta</button>
        <button id="verTicketsBtn"><i class="fas fa-list-alt"></i> Ver Consultas</button>
        <button id="horarioBtn"><i class="fas fa-calendar-alt"></i> Horario</button>
        <button id="estadisticasBtn"><i class="fas fa-chart-pie"></i> Estadísticas</button>
      </nav>
      
      <!-- Añadir botón de cerrar sesión -->
      <button id="logoutBtn" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>

      <!-- Botón solo para admin -->
      <button id="adminUsersBtn" class="admin-btn" style="display:none; margin-top:10px;"><i class="fas fa-users-cog"></i> Administrar usuarios</button>
      <button id="edicionesBtn" class="admin-only" style="display:none;"><i class="fas fa-history"></i> Ediciones</button>
      <div class="sidebar-footer">
        <p>© 2025 Veterinaria SMP</p>
      </div>
    </aside>

    <!-- Contenido principal -->
    <div class="content">
      <!-- Sección para crear tickets -->
      <section id="crearTicketSection" class="hidden">
        <h2><i class="fas fa-paw"></i> Crear Consulta</h2>
        <div class="form-container">
          <form id="ticketForm">
            <div class="form-row">
              <div class="form-group">
                <label for="nombre">Nombre del Cliente</label>
                <input type="text" id="nombre" required>
              </div>
              <div class="form-group">
                <label for="cedula">Cédula</label>
                <input type="text" id="cedula" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="mascota">Nombre de la Mascota</label>
                <input type="text" id="mascota" required>
              </div>
              <div class="form-group">
                <label for="tipoMascota">Tipo de Mascota</label>
                <select id="tipoMascota" required>
                  <option value="perro">Perro</option>
                  <option value="gato">Gato</option>
                  <option value="conejo">Conejo</option>
                  <option value="otro">Otro</option>
                </select>
                <span id="conejoImg" style="display:none; font-size:40px; margin-top:8px;">🐇</span>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="idPaciente">Número ID del paciente</label>
                <input type="text" id="idPaciente" placeholder="ID del paciente" required>
              </div>
              <div class="form-group">
                <label for="fecha">Fecha de Consulta</label>
                <input type="date" id="fecha" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="horaLlegada">Hora de Llegada</label>
                <input type="time" id="horaLlegada" required>
              </div>
              <div class="form-group">
                <label for="hora">Hora de Consulta</label>
                <input type="time" id="hora">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="doctorAtiende"><i class="fas fa-user-md"></i> Doctor que atiende</label>
                <select id="doctorAtiende" name="doctorAtiende">
                  <option value="">Seleccione un doctor</option>
                  <option value="Dr. Luis Coto">Dr. Luis Coto</option>
                  <option value="Dr. Randall Azofeifa">Dr. Randall Azofeifa</option>
                  <option value="Dr. Gustavo Gonzalez">Dr. Gustavo Gonzalez</option>
                  <option value="Dra. Daniela Sancho">Dra. Daniela Sancho</option>
                  <option value="Dra. Kharen Moreno">Dra. Kharen Moreno</option>
                  <option value="Dra. Karina Madrigal">Dra. Karina Madrigal</option>
                  <option value="Dra. Lourdes Chacón">Dra. Lourdes Chacón</option>
                  <option value="Dra. Sofia Carrillo">Dra. Sofia Carrillo</option>
                  <option value="Dra. Francinny Nuñez">Dra. Francinny Nuñez</option>
                  <option value="Dra. Karla Quesada">Dra. Karla Quesada</option>
                  <option value="Dra. Natalia Alvarado">Dra. Natalia Alvarado</option>
                </select>
              </div>
              <div class="form-group">
                <label for="asistenteAtiende"><i class="fas fa-user-nurse"></i> Asistente que atiende</label>
                <select id="asistenteAtiende" name="asistenteAtiende">
                  <option value="">Seleccione un asistente</option>
                  <option value="Tec. Maribel Guzmán">Tec. Maribel Guzmán</option>
                  <option value="Tec. Juliana Perez">Tec. Juliana Perez</option>
                  <option value="Tec. Jafeth Bermudez">Tec. Jafeth Bermudez</option>
                  <option value="Tec. Johnny Chacón">Tec. Johnny Chacón</option>
                  <option value="Tec. Gabriela Zuñiga">Tec. Gabriela Zuñiga</option>
                  <option value="Tec. Indra Perez">Tec. Indra Perez</option>
                  <option value="Tec. Randy Arias">Tec. Randy Arias</option>
                  <option value="Tec. Yancy Picado">Tec. Yancy Picado</option>
                  <option value="Tec. Maria Fernanda">Tec. Maria Fernanda</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="estado">Estado</label>
                <select id="estado" required>
                  <option value="espera">En Sala de Espera</option>
                  <option value="consultorio1">Consultorio 1</option>
                  <option value="consultorio2">Consultorio 2</option>
                  <option value="consultorio3">Consultorio 3</option>
                  <option value="consultorio4">Consultorio 4</option>
                  <option value="consultorio5">Consultorio 5</option>
                  <option value="terminado">Consulta Terminada</option>
                </select>
              </div>
              <div class="form-group">
                <label for="urgencia">Categorización de pacientes</label>
                <select id="urgencia" required>
                  <option value="Emergencia">🔴 Emergencias</option>
                  <option value="Urgencia">🟠 Urgencias</option>
                  <option value="Leve">🟢 Leve</option>
                  <option value="Consulta">🔵 Consulta</option>
                </select>
                <div id="urgenciaDesc" style="font-size:0.95em;color:#1976d2;margin-top:4px;"></div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="tipoServicio">Tipo de Servicio</label>
                <select id="tipoServicio" required>
                  <option value="consulta">Consulta general</option>
                  <option value="revaloracion">Revaloración</option>
                  <option value="retiroHilos">Retiro de hilos</option>
                  <option value="rayosX">Rayos X</option>
                  <option value="desparasitacion">Desparasitación</option>
                  <option value="inyectable">Inyectables</option>
                  <option value="vacunas">Vacunas</option>
                  <option value="consulta_8pm">Consulta después de las 8 P.M</option>
                  <option value="consulta_6pm">Consulta después de las 6 P.M</option>
                  <option value="hmg_limpieza">HMG Limpieza</option>
                  <option value="hmg_castracion">HMG Castración</option>
                  <option value="cambio_vendaje">Cambio de vendaje</option>
                  <option value="convenia_cx">Convenia de CX</option>
                  <option value="analito">Analito</option>
                  <option value="panel_general_basico">Panel General Básico</option>
                  <option value="panel_plus">Panel Plus</option>
                  <option value="perfil_quimico_general">Perfil quimico general</option>
                  <option value="perfil_pre_quirurgico">Perfil pre quirurgico</option>
                  <option value="perfil_renal">Perfil renal</option>
                  <option value="cirugia">Cirugía</option>
                  <option value="muestra_test">Muestra para test</option>
                  <option value="tiempos_coagulacion">Tiempos de coagulación</option>
                  <option value="internamiento">Internamiento</option>
                  <option value="test_sida_leucemia">Test sida leucemia</option>
                  <option value="corteUnas">Corte de uñas</option>
                  <option value="emergencia">Emergencia</option>
                  <option value="tomaMuestras">Toma de muestras</option>
                  <option value="tests">Tests</option>
                  <option value="hemograma">Hemograma</option>
                  <option value="eutanasia">Eutanasia</option>
                  <option value="quitarPuntos">Quitar puntos</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label for="numFactura">Número de factura</label>
                <input type="text" id="numFactura" placeholder="Número de factura">
              </div>
            </div>

            <div class="form-group">
              <label for="motivoLlegada">Motivo de Llegada</label>
              <textarea id="motivoLlegada" placeholder="Describa el motivo de llegada" required></textarea>
            </div>
            <div class="form-group">
              <label for="motivo">Motivo de Consulta</label>
              <textarea id="motivo" placeholder="Describa el motivo de la consulta"></textarea>
            </div>
            <div class="form-group">
              <label for="porCobrar">Por Cobrar</label>
              <input type="text" id="porCobrar" placeholder="Introduzca lo que hay que cobrar al cliente">
            </div>
            <button type="submit" class="btn-submit"><i class="fas fa-ticket-alt"></i> Agregar Consulta</button>
          </form>
        </div>
      </section>

      <!-- Sección para visualizar tickets -->
      <section id="verTicketsSection" class="hidden">
        <h2><i class="fas fa-list"></i> Sala de Espera</h2>
        
        <!-- Barra de búsqueda (visible para todos menos visitas) -->
        <div id="searchBarContainer" class="search-bar" style="display:none; margin-bottom: 15px;">
          <input type="text" id="ticketSearchInput" placeholder="Buscar por cliente, mascota, ID paciente o factura..." autocomplete="off">
          <i class="fas fa-search"></i>
        </div>
        
        <!-- nuevo filtro de fecha -->
        <div id="dateFilterContainer" class="date-filter hidden">
          <label for="filterDate"><i class="fas fa-calendar-alt"></i> Seleccionar fecha:</label>
          <input type="date" id="filterDate">
        </div>

        <div class="filter-container">
          <button class="filter-btn active" data-filter="todos">Todos</button>
          <button class="filter-btn" data-filter="espera">En Espera</button>
          <button class="filter-btn" data-filter="consultorio">En Consultorio</button>
          <button class="filter-btn" data-filter="terminado">Terminados</button>
          <button class="filter-btn" data-filter="porCobrar">Por Cobrar</button>
        </div>
        
        <div id="ticketContainer" class="ticket-container"></div>
      </section>
      
      <!-- Sección de estadísticas -->
      <section id="estadisticasSection" class="hidden">
        <h2><i class="fas fa-chart-bar"></i> Estadísticas</h2>
        <!-- Filtro global de periodo y fechas para estadísticas -->
        <div class="filtros-estadisticas-global" style="margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end;">
          <div class="filtro-grupo">
            <label for="filtroPeriodoGlobal">Período:</label>
            <select id="filtroPeriodoGlobal">
              <option value="hoy">Hoy</option>
              <option value="semana">Esta semana</option>
              <option value="mes">Este mes</option>
              <option value="ano">Este año</option>
              <option value="personalizado">Personalizado</option>
            </select>
          </div>
          <div id="periodPersonalizadoGlobal" class="filtro-periodo-personalizado" style="display: none; gap: 8px;">
            <div class="filtro-fecha">
              <label for="fechaInicioEstadisticasGlobal">Desde:</label>
              <input type="date" id="fechaInicioEstadisticasGlobal">
            </div>
            <div class="filtro-fecha">
              <label for="fechaFinEstadisticasGlobal">Hasta:</label>
              <input type="date" id="fechaFinEstadisticasGlobal">
            </div>
          </div>
          <button id="aplicarFiltrosEstadisticasBtn" class="btn-filtrar" style="margin-left: 8px;">
            <i class="fas fa-filter"></i> Aplicar filtros
          </button>
        </div>
        <div class="stats-container">
          <div class="stat-card">
            <i class="fas fa-users"></i>
            <h3>Total Pacientes</h3>
            <p id="totalPacientes">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-hourglass-half"></i>
            <h3>En Espera</h3>
            <p id="pacientesEspera">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-stethoscope"></i>
            <h3>En Consulta</h3>
            <p id="pacientesConsulta">0</p>
          </div>
          <div class="stat-card">
            <i class="fas fa-check-circle"></i>
            <h3>Atendidos</h3>
            <p id="pacientesAtendidos">0</p>
          </div>
        </div>
    

        <!-- Nuevo: Sección de tiempo promedio de espera por servicio -->
        <section class="wait-time-statistics">
          <h3><i class="fas fa-hourglass-half"></i> Tiempo Promedio de Espera por Servicio</h3>
          <div class="wait-time-chart">
            <canvas id="waitTimeChart"></canvas>
          </div>
          <div class="wait-time-table">
            <table class="stats-table">
              <thead>
                <tr>
                  <th>Servicio</th>
                  <th>Tiempo Promedio</th>
                  <th>Cantidad</th>
                </tr>
              </thead>
              <tbody id="waitTimeStatsBody">
                <!-- Se llenará dinámicamente -->
              </tbody>
            </table>
          </div>
        </section>

        <div class="estadisticas-personal-section">
          <h3><i class="fas fa-user-md"></i> Estadísticas por Personal y Servicio</h3>
          
          <div class="estadisticas-resultados">
            <div class="charts-container">
              <div class="chart-wrapper">
                <h4>Servicios por Personal</h4>
                <canvas id="chartServiciosPersonal"></canvas>
              </div>
              <div class="chart-wrapper">
                <h4>Distribución de Servicios</h4>
                <canvas id="chartDistribucionServicios"></canvas>
              </div>
            </div>
            
            <div class="tabla-estadisticas">
              <h4>Detalles por Personal</h4>
              <table id="tablaEstadisticasPersonal" class="stats-table">
                <thead>
                  <tr>
                    <th>Personal</th>
                    <th>Tipo de Servicio</th>
                    <th>Cantidad</th>
                    <th>% del Total</th>
                  </tr>
                </thead>
                <tbody id="tablaEstadisticasBody">
                  <!-- Se llenará dinámicamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Sección de ediciones (solo admin) -->
      <section id="edicionesSection" class="hidden">
        <h2><i class="fas fa-history"></i> Historial de Ediciones</h2>
        <div class="ediciones-container">
          <table class="stats-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Usuario</th>
                <th>Email</th>
                <th>ID Ticket</th>
                <th>Cambios Realizados</th>
              </tr>
            </thead>
            <tbody id="edicionesTableBody">
              <!-- Se llenará dinámicamente -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- Sección de horario -->
      <section id="horarioSection" class="hidden">
        <h2><i class="fas fa-calendar-alt"></i> Horario de Consultas</h2>
        
        <div class="date-controls">
          <input type="date" id="fechaHorario" value="">
          <button id="verHorarioBtn"><i class="fas fa-search"></i> Ver horario</button>
        </div>
        
        <div class="export-controls">
          <button id="exportarDiaBtn"><i class="fas fa-file-export"></i> Exportar día</button>
          <button id="exportarMesBtn"><i class="fas fa-file-export"></i> Exportar mes</button>
          <button id="exportarGoogleBtn"><i class="fab fa-google"></i> Exportar a Google Sheets</button>
        </div>
        
        <div class="horario-container">
          <table id="tablaHorario" class="horario-table">
            <thead>
              <tr>
                <th>Hora</th>
                <th>Cliente</th>
                <th>Mascota</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Urgencia</th>
                <th>Médico</th>
                <th>ID Paciente</th>
                <th>Factura</th>
                <th>Por Cobrar</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="horarioBody">
              <!-- Aquí se generarán las filas dinámicamente -->
            </tbody>
          </table>
        </div>
        
        <div class="backup-controls">
          <button id="backupBtn"><i class="fas fa-download"></i> Generar respaldo</button>
          <button id="cleanDataBtn"><i class="fas fa-broom"></i> Limpiar datos antiguos</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Plantillas para notificaciones y modales -->
  <div id="notificationContainer"></div>
  
  <!-- Modales -->
  <div id="editModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Editar Consulta</h3>
      <form id="editForm">
        <!-- El contenido del formulario se generará dinámicamente -->
      </form>
    </div>
  </div>
  
  <div id="statusModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3>Cambiar Estado</h3>
      <div id="statusOptions">
        <!-- Opciones de estado generadas dinámicamente -->
      </div>
      <div class="modal-actions">
        <button id="cancelStatusBtn">Cancelar</button>
        <button id="saveStatusBtn">Guardar</button>
      </div>
    </div>
  </div>

  <div id="adminModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h3><i class="fas fa-shield-alt"></i> Panel de Administración</h3>
      <div id="adminContent">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <!-- Modal de administración de usuarios -->
<div id="adminUsersModal" class="edit-modal" style="display:none;z-index:2000;">
  <div class="modal-content animate-scale" style="max-width:420px;">
    <span class="close-modal" id="closeAdminUsersModal" style="float:right;cursor:pointer;font-size:1.5rem;">&times;</span>
    <h3><i class="fas fa-users-cog"></i> Administración de Usuarios</h3>
    <form id="createUserForm">
      <div class="form-group">
        <label for="newUserEmail">Correo electrónico</label>
        <input type="email" id="newUserEmail" required>
      </div>
      <div class="form-group">
        <label for="newUserName">Nombre</label>
        <input type="text" id="newUserName" required>
      </div>
      <div class="form-group">
        <label for="newUserRole">Rol</label>
        <select id="newUserRole" required>
          <option value="recepcion">Recepción</option>
          <option value="consulta_externa">Consulta Externa</option>
          <option value="quirofano">Quirofano</option>
          <option value="internos">Internos</option>
          <option value="visitas">Visitas</option>
        </select>
      </div>
      <button type="submit" class="btn-save" style="width:100%;margin-bottom:10px;">Crear usuario</button>
    </form>
  </div>
</div>
  <!-- External scripts - keep these external references -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="firebase-config.js"></script>
  <script src="auth.js"></script>
  <script src="index.js"></script>
  <script src="fix-wait-time.js"></script>
<script src="admin-users.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const tipoMascota = document.getElementById('tipoMascota');
  const conejoImg = document.getElementById('conejoImg');
  if (tipoMascota && conejoImg) {
    tipoMascota.addEventListener('change', function() {
      conejoImg.style.display = tipoMascota.value === 'conejo' ? 'inline-block' : 'none';
    });
  }

  // Ocultar campo Hora de Cita según el rol
  const userRole = sessionStorage.getItem('userRole');
  const horaCitaGroup = document.querySelector('input#hora')?.closest('.form-group');
  if (horaCitaGroup) {
    if (!["admin", "recepción", "quirofano"].includes(userRole)) {
      horaCitaGroup.style.display = 'none';
    } else {
      horaCitaGroup.style.display = '';
    }
  }

  // Descripciones para cada categorización
  const urgenciaDescriptions = {
    emergencia: 'Emergencias. Situaciones críticas que requieren atención médica inmediata. Se mostrará como EMERGENCIA en el ticket.',
    urgencia: 'Urgencias. Problemas de salud que deben atenderse pronto, pero no son críticos.',
    leve: 'Leve. Puede esperar, sin riesgo inmediato.',
    consulta: 'Consulta. Atención general o rutinaria.'
  };

  function updateUrgenciaDescription(selectId, descId) {
    const select = document.getElementById(selectId);
    const desc = document.getElementById(descId);
    if (!select || !desc) return;
    const value = select.value;
    desc.textContent = urgenciaDescriptions[value] || '';
  }

  // Descripción dinámica en creación
  const urgenciaSelect = document.getElementById('urgencia');
  if (urgenciaSelect) {
    const descDiv = document.createElement('div');
    descDiv.id = 'urgenciaDesc';
    descDiv.style.fontSize = '0.95em';
    descDiv.style.color = '#1976d2';
    descDiv.style.marginTop = '4px';
    urgenciaSelect.parentNode.appendChild(descDiv);
    urgenciaSelect.addEventListener('change', function() {
      updateUrgenciaDescription('urgencia', 'urgenciaDesc');
    });
    updateUrgenciaDescription('urgencia', 'urgenciaDesc');
  }
});

// Navegación con flechas en el formulario de tickets
(function() {
  const form = document.getElementById('ticketForm');
  if (!form) return;
  // Selecciona todos los inputs, selects y textareas visibles en orden
  const getFields = () => Array.from(form.querySelectorAll('input, select, textarea')).filter(el => el.offsetParent !== null && !el.disabled);

  form.addEventListener('keydown', function(e) {
    const fields = getFields();
    const idx = fields.indexOf(document.activeElement);
    if (idx === -1) return;
    // Columnas por fila (ajustar si cambias el diseño)
    const cols = 2;
    // Flecha abajo
    if (e.key === 'ArrowDown') {
      if (idx + cols < fields.length) {
        fields[idx + cols].focus();
        e.preventDefault();
      }
    }
    // Flecha arriba
    else if (e.key === 'ArrowUp') {
      if (idx - cols >= 0) {
        fields[idx - cols].focus();
        e.preventDefault();
      }
    }
    // Flecha derecha
    else if (e.key === 'ArrowRight') {
      if ((idx + 1) % cols !== 0 && idx + 1 < fields.length) {
        fields[idx + 1].focus();
        e.preventDefault();
      }
    }
    // Flecha izquierda
    else if (e.key === 'ArrowLeft') {
      if (idx % cols !== 0 && idx - 1 >= 0) {
        fields[idx - 1].focus();
        e.preventDefault();
      }
    }
  });
})();
</script>
</body>
</html>