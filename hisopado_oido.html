<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hisopado de O√≠do</title>
    <link rel="stylesheet" href="index_lab.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="text/javascript">window.jsPDF = window.jspdf.jsPDF;</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ABeeZee:ital@0;1&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=League+Spartan:wght@100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <style>
        /* Oculta elementos durante la generaci√≥n de PDF */
        .pdf-hide { display: none !important; }
    </style>
    <script>
        // Autollenado desde par√°metros URL
        document.addEventListener('DOMContentLoaded', function(){
            try {
                const params = new URLSearchParams(window.location.search);
                const setVal = (id, val) => { const el = document.getElementById(id); if (el && val!=null && val!=='') el.value = val; };
                setVal('mascotaNombre', params.get('mascotaNombre'));
                setVal('propietarioNombre', params.get('propietarioNombre'));
                setVal('propietarioCedula', params.get('propietarioCedula'));
                setVal('propietarioTelefono', params.get('propietarioTelefono'));
                setVal('propietarioEmail', params.get('propietarioEmail'));
                setVal('nombreMedico', params.get('nombreMedico'));
                setVal('mascotaRaza', params.get('mascotaRaza'));
                setVal('mascotaEdad', params.get('mascotaEdad'));
                setVal('mascotaPeso', params.get('mascotaPeso'));
                // Especie/Sexo
                const especie = params.get('especie');
                const sexo = params.get('mascotaSexo');
                const especieSelector = document.getElementById('especieSelector');
                const sexoSelector = document.getElementById('sexoSelector');
                if (especieSelector && especie) { especieSelector.value = capitalize(especie); actualizarEspecieEnPlantilla(); }
                if (sexoSelector && sexo) { sexoSelector.value = capitalize(sexo); actualizarSexoEnPlantilla(); }
                
                // Verificar el mensaje del m√©dico despu√©s del autollenado
                const medico = params.get('nombreMedico');
                if (medico) {
                    setTimeout(() => {
                        verificarMedico();
                    }, 100);
                }
            } catch(e){ console.warn('Autollenado hisopado o√≠do fall√≥:', e); }
            function capitalize(s){ if(!s) return s; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
        });
    </script>
</head>
<body>
    <div class="controls">
        <label for="sexoSelector">Selecciona el sexo:</label>
        <select id="sexoSelector" onchange="actualizarSexoEnPlantilla()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Macho">Macho</option>
            <option value="Hembra">Hembra</option>
        </select>
        <label for="especieSelector">Selecciona la especie:</label>
        <select id="especieSelector" onchange="actualizarEspecieEnPlantilla()">
            <option value="Seleccionar" selected>-- Seleccionar --</option>
            <option value="Canino">Canino</option>
            <option value="Felino">Felino</option>
            <option value="Lagomorfo">Lagomorfo</option>
            <option value="Cuilo">Cuilo</option>
        </select>
    </div>

    <div class="container" style="display: block;">
        <div class="header">
            <img src="empresa.jpg" alt="Logo de la Empresa" class="small-image">
            <h1>Laboratorio Cl√≠nico Veterinario</h1>
        </div>
        <h3 class="subheader">HISOPADO DE O√çDO</h3>
            <table>
                <thead>
                    <tr>
                        <th colspan="2">DATOS DE LA MASCOTA</th>
                        <th colspan="2">DATOS DEL PROPIETARIO</th>
                    </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Nombre</td>
                    <td><input type="text" id="mascotaNombre" onkeydown="moverFocoConFlechas(event, 'propietarioNombre', 'propietarioNombre', 'mascotaNombre', 'mascotaRaza')"></td>
                    <td>Nombre</td>
                    <td><input type="text" id="propietarioNombre" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'propietarioCedula')"></td>
                </tr>
                <tr>
                    <td>Raza</td>
                    <td><input type="text" id="mascotaRaza" list="razas" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaNombre', 'mascotaNombre', 'mascotaSexo')"></td>
                    <datalist id="razas"></datalist>
                    <td>C√©dula</td>
                    <td><input type="text" id="propietarioCedula" onkeydown="moverFocoConFlechas(event, 'propietarioTelefono', 'mascotaRaza', 'propietarioNombre', 'propietarioTelefono')"></td>
                </tr>
                <tr>
                    <td>Sexo</td>
                    <td><input type="text" id="sexoEnPlantilla"></td>
                    <td>Tel√©fono</td>
                    <td><input type="text" id="propietarioTelefono" onkeydown="moverFocoConFlechas(event, 'propietarioCedula', 'mascotaSexo', 'propietarioCedula', 'propietarioEmail')"></td>
                </tr>
                <tr>
                    <td>Especie</td>
                    <td><input type="text" id="especieEnPlantilla"></td>
                    <td>Email</td>
                    <td><input type="text" id="propietarioEmail" onkeydown="moverFocoConFlechas(event, 'mascotaEspecie', 'mascotaEspecie', 'propietarioTelefono', 'nombreMedico')"></td>
                </tr>
                <tr>
                    <td>Edad</td>
                    <td><input type="text" id="mascotaEdad" list="edades" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaEspecie', 'mascotaEspecie', 'mascotaPeso')"></td>
                    <datalist id="edades">
                        <option value="1 mes"><option value="2 meses"><option value="3 meses"><option value="4 meses">
                        <option value="5 meses"><option value="6 meses"><option value="7 meses"><option value="8 meses"><option value="9 meses">
                        <option value="10 meses"><option value="11 meses"><option value="12 meses">
                        <option value="1 a√±o"><option value="2 a√±os"><option value="3 a√±os"><option value="4 a√±os">
                        <option value="5 a√±os"><option value="6 a√±os"><option value="7 a√±os"><option value="8 a√±os"><option value="9 a√±os">
                        <option value="10 a√±os"><option value="11 a√±os"><option value="12 a√±os"><option value="13 a√±os"></option><option value="14 a√±os"></option>
                        <option value="15 a√±os"><option value="16 a√±os"><option value="17 a√±os"><option value="18 a√±os"></option>
                        <option value="19 a√±os"><option value="20 a√±os"></option>    
                    </datalist>
                    <td>M√©dico</td>
                    <td>
                        <input type="text" id="nombreMedico" list="medicos" 
                            onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'propietarioEmail', 'propietarioFecha')" 
                            oninput="verificarMedico()">
                    </td>
                    <datalist id="medicos">
                        <option value="N.A">
                        <option value="Dr. Randall Azofeifa">
                        <option value="Dr. Luis Coto">
                        <option value="Dra. Daniela Sancho">
                        <option value="Dra. Sofia Carrillo">
                        <option value="Dra. Franciny Nu√±ez">
                        <option value="Dra. Maria Chac√≥n">
                        <option value="Dra. Alejandra Le√≥n">
                        <option value="Dra. Karla Quesada">
                        <option value="Dra. Kharen Moreno">
                        <option value="Dra. Karina Madrigal">
                        <option value="Dra. Natalia Alvarado">
                    </datalist>
                </tr>
                <tr>
                    <td>Peso</td>
                    <td><input type="text" id="mascotaPeso" list="pesos" onkeydown="moverFocoConFlechas(event, 'propietarioFecha', 'mascotaEdad', 'mascotaEdad', 'mascotaPeso')"></td>
                    <datalist id="pesos">
                        <option value="N.A">N.A</option><option value="0,1 kg">0,1 kg</option><option value="0,2 kg">0,2 kg</option><option value="0,3 kg">0,3 kg</option><option value="0,4 kg">0,4 kg</option>
                        <option value="0,5 kg">0,5 kg</option><option value="0,6 kg">0,6 kg</option><option value="0,7 kg">0,7 kg</option><option value="0,8 kg">0,8 kg</option><option value="0,9 kg">0,9 kg</option>
                        <option value="1,0 kg">1,0 kg</option><option value="1,1 kg">1,1 kg</option><option value="1,2 kg">1,2 kg</option><option value="1,3 kg">1,3 kg</option><option value="1,4 kg">1,4 kg</option>
                        <option value="1,5 kg">1,5 kg</option><option value="1,6 kg">1,6 kg</option><option value="1,7 kg">1,7 kg</option><option value="1,8 kg">1,8 kg</option><option value="1,9 kg">1,9 kg</option>
                        <option value="2,0 kg">2,0 kg</option><option value="2,1 kg">2,1 kg</option><option value="2,2 kg">2,2 kg</option><option value="2,3 kg">2,3 kg</option><option value="2,4 kg">2,4 kg</option>
                        <option value="2,5 kg">2,5 kg</option><option value="2,6 kg">2,6 kg</option><option value="2,7 kg">2,7 kg</option><option value="2,8 kg">2,8 kg</option><option value="2,9 kg">2,9 kg</option>
                        <option value="3,0 kg">3,0 kg</option><option value="3,1 kg">3,1 kg</option><option value="3,2 kg">3,2 kg</option><option value="3,3 kg">3,3 kg</option><option value="3,4 kg">3,4 kg</option>
                        <option value="3,5 kg">3,5 kg</option><option value="3,6 kg">3,6 kg</option><option value="3,7 kg">3,7 kg</option><option value="3,8 kg">3,8 kg</option><option value="3,9 kg">3,9 kg</option>
                        <option value="4,0 kg">4,0 kg</option><option value="4,1 kg">4,1 kg</option><option value="4,2 kg">4,2 kg</option><option value="4,3 kg">4,3 kg</option><option value="4,4 kg">4,4 kg</option>
                        <option value="4,5 kg">4,5 kg</option><option value="4,6 kg">4,6 kg</option><option value="4,7 kg">4,7 kg</option><option value="4,8 kg">4,8 kg</option><option value="4,9 kg">4,9 kg</option>
                        <option value="5,0 kg">5,0 kg</option><option value="5,1 kg">5,1 kg</option><option value="5,2 kg">5,2 kg</option><option value="5,3 kg">5,3 kg</option><option value="5,4 kg">5,4 kg</option>
                        <option value="5,5 kg">5,5 kg</option><option value="5,6 kg">5,6 kg</option><option value="5,7 kg">5,7 kg</option><option value="5,8 kg">5,8 kg</option><option value="5,9 kg">5,9 kg</option>
                        <option value="6,0 kg">6,0 kg</option><option value="6,1 kg">6,1 kg</option><option value="6,2 kg">6,2 kg</option><option value="6,3 kg">6,3 kg</option><option value="6,4 kg">6,4 kg</option>
                        <option value="6,5 kg">6,5 kg</option><option value="6,6 kg">6,6 kg</option><option value="6,7 kg">6,7 kg</option><option value="6,8 kg">6,8 kg</option><option value="6,9 kg">6,9 kg</option>
                        <option value="7,0 kg">7,0 kg</option><option value="7,1 kg">7,1 kg</option><option value="7,2 kg">7,2 kg</option><option value="7,3 kg">7,3 kg</option><option value="7,4 kg">7,4 kg</option>
                        <option value="7,5 kg">7,5 kg</option><option value="7,6 kg">7,6 kg</option><option value="7,7 kg">7,7 kg</option><option value="7,8 kg">7,8 kg</option><option value="7,9 kg">7,9 kg</option>
                        <option value="8,0 kg">8,0 kg</option><option value="8,1 kg">8,1 kg</option><option value="8,2 kg">8,2 kg</option><option value="8,3 kg">8,3 kg</option><option value="8,4 kg">8,4 kg</option>
                        <option value="8,5 kg">8,5 kg</option><option value="8,6 kg">8,6 kg</option><option value="8,7 kg">8,7 kg</option><option value="8,8 kg">8,8 kg</option><option value="8,9 kg">8,9 kg</option>
                        <option value="9,0 kg">9,0 kg</option><option value="9,1 kg">9,1 kg</option><option value="9,2 kg">9,2 kg</option><option value="9,3 kg">9,3 kg</option><option value="9,4 kg">9,4 kg</option>
                        <option value="9,5 kg">9,5 kg</option><option value="9,6 kg">9,6 kg</option><option value="9,7 kg">9,7 kg</option><option value="9,8 kg">9,8 kg</option><option value="9,9 kg">9,9 kg</option>
                        <option value="10,0 kg">10,0 kg</option><option value="10,1 kg">10,1 kg</option><option value="10,2 kg">10,2 kg</option><option value="10,3 kg">10,3 kg</option><option value="10,4 kg">10,4 kg</option>
                        <option value="10,5 kg">10,5 kg</option><option value="10,6 kg">10,6 kg</option><option value="10,7 kg">10,7 kg</option><option value="10,8 kg">10,8 kg</option><option value="10,9 kg">10,9 kg</option>
                        <option value="11,0 kg">11,0 kg</option><option value="11,1 kg">11,1 kg</option><option value="11,2 kg">11,2 kg</option><option value="11,3 kg">11,3 kg</option><option value="11,4 kg">11,4 kg</option>
                        <option value="11,5 kg">11,5 kg</option><option value="11,6 kg">11,6 kg</option><option value="11,7 kg">11,7 kg</option><option value="11,8 kg">11,8 kg</option><option value="11,9 kg">11,9 kg</option>
                        <option value="12,0 kg">12,0 kg</option>
                    </datalist>
                    <td>Fecha</td>
                    <td><input type="date" id="propietarioFecha" class="date-input" onkeydown="moverFocoConFlechas(event, 'nombreMedico', 'mascotaPeso', 'nombreMedico', 'propietarioFecha')"></td>
                </tr>
            </tbody>
        </table>

        <table>
            <thead>
                <tr><th colspan="2">HISOPADO DE O√çDO</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td style="width: 30%;">TINCI√ìN GRAM:</td>
                    <td>
                        <input type="text" id="tincionGram" list="gramOptions">
                        <datalist id="gramOptions">
                            <option value="Bacterias Gram Positivas">
                            <option value="Bacterias Gram Negativas">
                        </datalist>
                    </td>
                </tr>
                <tr>
                    <td rowspan="2">TINCI√ìN DIFF QUIK:</td>
                    <td>
                        <input type="text" id="diffQuik1" value="Se observan estructuras levaduriformes compatibles con Malassezia spp">
                    </td>
                </tr>
                <tr>
                    <td>
                        <input type="text" id="diffQuik2" value="Se observan c√©lulas epiteliales en escasa cantidad">
                    </td>
                </tr>
                <tr>
                    <td>ACEITE INMERSI√ìN:</td>
                    <td>
                        <input type="text" id="aceiteInmersion" value="No se observan √°caros">
                    </td>
                </tr>
                <tr>
                    <td>KOH:</td>
                    <td>
                        <input type="text" id="koh" value="No se observan estructuras compatibles con derm√°tofitos">
                    </td>
                </tr>
            </tbody>
        </table>

        <!-- Secci√≥n de carga de imagen -->
        <div class="image-upload-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
            <h4 style="margin-bottom: 10px;">üì∑ Cargar Imagen del An√°lisis</h4>
            <label for="imageHisopado" style="display: inline-block; padding: 10px 20px; background: #007bff; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;">
                Seleccionar Imagen
            </label>
            <input type="file" id="imageHisopado" accept="image/*" onchange="previewImage(event, 'previewHisopado')" style="display: none;">
            <div id="hisopado-preview-container" style="margin-top: 15px; display: none;">
                <p style="color: #28a745; font-weight: bold;">‚úì Imagen cargada correctamente</p>
                <img id="previewHisopado-mini" style="max-width: 200px; max-height: 150px; border: 2px solid #28a745; border-radius: 5px; margin-top: 10px;">
            </div>
        </div>

        <!-- Secci√≥n de visualizaci√≥n de imagen para el PDF -->
        <div class="image-container" style="display: flex; justify-content: center; margin: 20px 0;">
            <div class="image-box analysis-box" style="text-align: center; max-width: 50%;">
                <h4>Imagen del An√°lisis</h4>
                <div class="pdf-hide" style="margin-bottom: 10px;">
                    <label for="uploadHisopado">Seleccionar imagen:</label>
                    <input type="file" id="uploadHisopado" accept="image/*" onchange="previewImage(event, 'previewHisopado')" style="display: inline-block;">
                </div>
                <div style="margin-top: 10px; min-height: 200px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center;">
                    <img id="previewHisopado" alt="Imagen del An√°lisis" style="max-width: 100%; max-height: 200px; display: none;">
                    <span id="noImageHisopado" class="pdf-hide">Sin imagen</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p id="mensajeMedico" style="display: none;">El personal m√©dico cuenta con un plazo de 24 a 48 horas para interpretar el reporte de los resultados.</p>
            <p>Facebook: Veterinaria San Martin de Porres | Tel√©fono: 4000 - 1365 | Ext: 106</p>
            <p>WhatsApp: 8839 - 2214 | San Rafael Abajo de Desamparados, 50 metros Norte del Mall Zona Centro</p>
            <p>Correo: laboratorio@vetsanmartin.com</p>
        </div>
    </div>

    <div class="controls">
        <button id="pdfButton" onclick="generatePDF()">Generar PDF</button>
        <button id="menuButton" onclick="window.location.href='index.html'">Volver al Men√∫</button>
        <div id="loadingPdf" class="loading-indicator" style="display:none;">
            <div class="spinner"></div>
            <span>Generando PDF...</span>
        </div>
    </div>

    <script>
        // Funciones para actualizar sexo y especie
        function actualizarSexoEnPlantilla() {
            const sexo = document.getElementById('sexoSelector').value;
            const sexoCapitalizado = sexo.charAt(0).toUpperCase() + sexo.slice(1);
            document.getElementById('sexoEnPlantilla').value = sexoCapitalizado;
        }

        function actualizarEspecieEnPlantilla() {
            const especie = document.getElementById('especieSelector').value;
            document.getElementById('especieEnPlantilla').value = especie;
            actualizarRazasPorEspecie();
        }

        function verificarMedico() {
            const medico = document.getElementById('nombreMedico').value;
            const mensaje = document.getElementById('mensajeMedico');
            
            // Verificar si el m√©dico es N.A en cualquier variante o est√° vac√≠o
            const isNA = !medico || 
                       medico.trim() === '' || 
                       medico.toUpperCase() === 'N.A' || 
                       medico.toUpperCase() === 'NA' || 
                       medico.toUpperCase() === 'N.A.';
            
            if (isNA) {
                mensaje.style.display = 'none';
            } else {
                mensaje.style.display = 'block';
            }
        }

        // Navegaci√≥n con teclas
        function moverFocoConFlechas(event, derechaId, izquierdaId, arribaId, abajoId) {
            switch (event.key) {
                case 'ArrowRight':
                    event.preventDefault();
                    document.getElementById(derechaId).focus();
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    document.getElementById(izquierdaId).focus();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    document.getElementById(arribaId).focus();
                    break;
                case 'Enter':
                case 'ArrowDown':
                    event.preventDefault();
                    document.getElementById(abajoId).focus();
                    break;
            }
        }

        // Listas de razas
        const razasCaninas = [
            "Ainu", "Airedale terrier", "Akita", "Akita Inu", "Alaskan Malamute",
            "American Black and Tan Coonhound", "American Bull Terrier", "American Pit Bull Terrier",
            "American Staffordshire terrier", "American Water Spaniel", "Apso Tibetano", "Barzoi", 
            "Basenji", "Basset Hound", "Beagle", "Bichon Frise", "Bloodhound", "Bobtail", 
            "Border Collie", "Boston Terrier", "Bouvier des Flandres", "Boxer", "Bull terrier", 
            "Bull Terrier Miniatura", "Bulldog Americano", "Bulldog Franc√©s", "Bulldog Ingl√©s", 
            "Bullmastiff", "Cavalier King Charles Spaniel", "Chihuahua", "Chow Chow", 
            "Cocker Spaniel Americano", "Cocker Spaniel Ingl√©s", "Collie", "Collie Escoc√©s", 
            "Dachshund", "D√°lmata", "Doberman", "Doberman Pincher", "Dogo Alem√°n", 
            "Dogo Argentino", "Dogo de Burdeos", "French Poodle", "Galgo Espa√±ol", 
            "Galgo Ingl√©s-espa√±ol", "Golden Retriever", "Gran Dan√©s", "Greyhound", 
            "Husky Siberiano", "Jack Russell Terrier", "Labrador Retriever", "Malt√©s", 
            "Pastor Alem√°n", "Pequin√©s", "Pomerania", "Pug", "Rottweiler", "Samoyedo", 
            "San Bernardo", "Schnauzer", "Shih Tzu", "SRD", "Yorkshire Terrier", "Weimaraner", "Fila Brasileiro",
        ];

        const razasFelinas = [
            "Abisinio", "American Bobtail", "Angora Turco", "Azul Ruso", "Balin√©s", 
            "Bengal√≠", "Bobtail japon√©s", "Bombay", "British Shorthair", "Burm√©s", 
            "Carey", "Com√∫n Europeo", "Ex√≥tico", "Himalayo", "Javan√©s", 
            "Oriental", "Persa", "Sagrado de Birmania", "Siam√©s", "Siberiano", 
            "Silvestre", "SRD"
        ];

        function actualizarRazasPorEspecie() {
            const especie = document.getElementById('especieSelector').value;
            let datalistRazas = document.getElementById('razas');
            if (!datalistRazas) {
                datalistRazas = document.createElement('datalist');
                datalistRazas.id = 'razas';
                document.body.appendChild(datalistRazas);
            } else {
                datalistRazas.innerHTML = '';
            }
            const campoRaza = document.getElementById('mascotaRaza');
            if (campoRaza.value && campoRaza.value !== "SRD") {
                campoRaza.value = '';
            }
            if (especie === "Canino") {
                razasCaninas.forEach(raza => {
                    const option = document.createElement('option');
                    option.value = raza;
                    datalistRazas.appendChild(option);
                });
            } else if (especie === "Felino") {
                razasFelinas.forEach(raza => {
                    const option = document.createElement('option');
                    option.value = raza;
                    datalistRazas.appendChild(option);
                });
            } else if (especie === "Lagomorfo" || especie === "Cuilo") {
                const option = document.createElement('option');
                option.value = "SRD";
                datalistRazas.appendChild(option);
            }
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const especieSelector = document.getElementById('especieSelector');
            if (especieSelector) {
                actualizarRazasPorEspecie();
                especieSelector.addEventListener('change', actualizarRazasPorEspecie);
            }
            const campoRaza = document.getElementById('mascotaRaza');
            if (campoRaza && campoRaza.getAttribute('list') !== 'razas') {
                campoRaza.setAttribute('list', 'razas');
            }
        });

        // Funci√≥n para previsualizar im√°genes
        function previewImage(event, previewId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            let noImageText = null;
            let miniPreview = null;
            let previewContainer = null;
            
            if (previewId === 'previewHisopado') {
                noImageText = document.getElementById('noImageHisopado');
                miniPreview = document.getElementById('previewHisopado-mini');
                previewContainer = document.getElementById('hisopado-preview-container');
            } else {
                noImageText = preview?.parentElement?.querySelector('span');
            }
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function() {
                    if (preview) {
                        preview.src = reader.result;
                        preview.style.display = 'block';
                    }
                    if (noImageText) noImageText.style.display = 'none';
                    
                    if (miniPreview) {
                        miniPreview.src = reader.result;
                    }
                    if (previewContainer) {
                        previewContainer.style.display = 'block';
                    }
                }
                reader.readAsDataURL(file);
            } else {
                if (preview) preview.style.display = 'none';
                if (noImageText) noImageText.style.display = 'block';
                if (previewContainer) previewContainer.style.display = 'none';
            }
        }

        // Generar PDF
        async function generatePDF() {
            const loadingIndicator = document.getElementById('loadingPdf');
            const pdfButton = document.getElementById('pdfButton');
            const menuButton = document.getElementById('menuButton');
            
            loadingIndicator.style.display = 'flex';
            pdfButton.disabled = true;
            menuButton.disabled = true;
            
            try {
                const { jsPDF } = window.jspdf;
                const container = document.querySelector('.container');
                
                // PRIMERO: Asegurar que la imagen se muestre si est√° cargada (antes de ocultar controles)
                const previewImage = document.getElementById('previewHisopado');
                if (previewImage && previewImage.src && previewImage.src !== '' && !previewImage.src.includes(window.location.href)) {
                    previewImage.style.display = 'block';
                    previewImage.style.visibility = 'visible';
                }
                
                // AHORA: Ocultar elementos no deseados
                document.querySelectorAll('.pdf-hide').forEach(el => {
                    el.style.display = 'none';
                });
                
                // Asegurar que la imagen siga visible despu√©s de ocultar controles
                if (previewImage && previewImage.src && previewImage.src !== '' && !previewImage.src.includes(window.location.href)) {
                    previewImage.style.display = 'block';
                    previewImage.style.visibility = 'visible';
                }
                // Ocultar las secciones de carga de imagen visibles
                document.querySelectorAll('.image-upload-section').forEach(el => {
                    el.style.display = 'none';
                });
                
                const images = container.getElementsByTagName('img');
                const loadImages = Array.from(images).map(img => {
                    return new Promise((resolve, reject) => {
                        if (img.complete) resolve();
                        else { img.onload = resolve; img.onerror = reject; }
                    });
                });
                await Promise.all(loadImages);
                
                const canvas = await html2canvas(container, { 
                    scale: 3, 
                    useCORS: true, 
                    backgroundColor: '#ffffff' 
                });
                
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 180;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                const marginLeft = (210 - imgWidth) / 2;
                
                pdf.addImage(imgData, 'JPEG', marginLeft, 10, imgWidth, imgHeight);
                
                // Restaurar visibilidad
                document.querySelectorAll('.pdf-hide').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.image-upload-section').forEach(el => {
                    el.style.display = 'block';
                });
                
                const petName = document.getElementById('mascotaNombre')?.value.trim() || '';
                const ownerFull = document.getElementById('propietarioNombre')?.value.trim() || '';
                const ownerParts = ownerFull.split(/\s+/);
                const firstSurname = ownerParts.length > 1 ? ownerParts[1] : ownerParts[0] || '';
                const fileName = `Hisopado de O√≠do ${petName} ${firstSurname}.pdf`;
                
                pdf.save(fileName);
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Ocurri√≥ un error al generar el PDF: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
                pdfButton.disabled = false;
                menuButton.disabled = false;
                // Restaurar visibilidad en caso de error
                document.querySelectorAll('.pdf-hide').forEach(el => {
                    el.style.display = 'block';
                });
                document.querySelectorAll('.image-upload-section').forEach(el => {
                    el.style.display = 'block';
                });
            }
        }
    </script>
</body>
</html>
